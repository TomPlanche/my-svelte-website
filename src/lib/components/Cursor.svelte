<script lang="ts">
	// Imports
	import {spring} from "svelte/motion";
	import type {T_CursorOptions} from "../types";

	// Variables
	const cursor_base = {size: 15};

	// Springs
	const opacity = spring(0);
	const coords = spring({
		x: 0,
		y: 0,
	}, {stiffness: 0.3, damping: 0.8});
    const size = spring(cursor_base.size);
	const blur = spring(0);

	let background = "#eeeeee90";
	let hasMoved = false as boolean;

	let innerSvg: string;
	let innerText: string;

	// Functions
	/**
	 * Set the cursor params
	 * This function is set to be used by the $store.cursor.setParams function in the store.
	 * @param params
	 */
	export const setCursorParams = (params: T_CursorOptions) => {
		if (params.isHover) {
			// params.svg can be undefined, a svg string or a boolean
			if (params.svg) {
				innerSvg = params.svg;
			}

			if (params.innerText) {
				innerText = params.innerText;
			}

			opacity.set(params.opacity ?? 0.5);
			blur.set(params.blur ?? 0);
			background = params.backgroundColor ?? "#eeeeee90";


		} else {
			if (params.svg === false || params.svg === undefined) {
				innerSvg = undefined;
				opacity.set(params.opacity ?? 1);
			} else {
				opacity.set(params.opacity ?? 1);
			}

			if (params.innerText === false || params.innerText === undefined) {
				innerText = undefined;
			}

			blur.set(params.blur ?? 0);
			background = params.backgroundColor ?? "#eeeeee90";
		}

		size.set(params.scale ? cursor_base.size * params.scale : cursor_base.size);
	};

	// if hasMoved is false, then the cursor is not visible
	$: if (!hasMoved) {
		opacity.set(0);
	} else {
		setTimeout(() => {
			opacity.set(1);
		}, 150);
	}
</script>

<!-- The window is used to get the mouse position -->
<svelte:window
	on:mousemove={(e) => {
		!hasMoved && (hasMoved = true);

		coords.set({
			x: e.clientX,
			y: e.clientY,
		})
	}}
	on:mousedown={() => {
		size.update((s) => s * 1.5);
	}}
	on:mouseup={() => {
		size.update((s) => s / 1.5);
	}}
/>

<!-- The svg is always displayed -->
<svg
	aria-hidden="true"
>
	<circle
		cx={$coords.x}
		cy={$coords.y}
		r={$size}
		style="
			opacity: {$opacity};
			filter: blur({$blur}px);
			fill: {background};
		"
	/>
</svg>

<!-- If there is a svg, then we display it -->
{#if innerSvg}
	<img
		src={innerSvg}
		alt="Github gif"
		style="
			height: {$size * 2}px;
			width: {$size * 2}px;
			transform: translate({$coords.x - $size}px, {$coords.y - $size}px);
		"
	/>
{/if}

<!-- If something is in the default slot, then we display it -->
{#if $$slots.default || innerText}
	<div
		class="html-container"
		style="
			height: {$size * 2}px;
			width: {$size * 2}px;
			transform: translate({$coords.x - $size}px, {$coords.y - $size}px) scale({$size / cursor_base.size});
		"
	>
		{#if $$slots.default}
			<slot />
		{:else}
			{innerText}
		{/if}
	</div>
{/if}



<style lang="scss">
	svg {
		position: fixed;
		top: 0;
		left: 0;

		pointer-events: none;

		width: 100%;
		height: 100%;

		z-index: 99998;

	}

	img {
		position: absolute;
		top: 0;
		left: 0;

		pointer-events: none;
		z-index: 99999;
	}

	.html-container {
		position: fixed;
		top: 0;
		left: 0;

		display: flex;
		justify-content: center;
		align-items: center;


		z-index: 99998;

		pointer-events: none;
	}
</style>
